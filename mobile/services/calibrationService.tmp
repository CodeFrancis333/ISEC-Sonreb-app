// mobile/services/calibrationService.ts
import { apiRequest } from "./apiClient";

export type CalibrationPoint = {
  id: string;
  project: string; // project ID
  member?: string; // member ID (optional)
  upv: number;
  rh_index: number;
  carbonation_depth?: number | null;
  core_fc: number;
  notes?: string;
  created_at: string; // ISO string
};

export type CalibrationModel = {
  id: string;
  project: string; // project ID
  a0: number;
  a1: number;
  a2: number;
  a3?: number | null;
  r2: number;
  rmse?: number | null;
  points_used: number;
  use_carbonation: boolean;
  upv_min?: number | null;
  upv_max?: number | null;
  rh_min?: number | null;
  rh_max?: number | null;
  carbonation_min?: number | null;
  carbonation_max?: number | null;
  created_at: string;
};

export type CreateCalibrationPointPayload = {
  project: string;
  member?: string;
  upv: number;
  rh_index: number;
  carbonation_depth?: number | null;
  core_fc: number;
  notes?: string;
};

export type GenerateModelPayload = {
  project: string;
  use_carbonation: boolean;
};

export async function listCalibrationPoints(
  projectId: string,
  token?: string | null
): Promise<CalibrationPoint[]> {
  return apiRequest<CalibrationPoint[]>(
    `/calibration/points/?project=${projectId}`,
    {
      method: "GET",
      token: token || undefined,
    }
  );
}

export async function createCalibrationPoint(
  payload: CreateCalibrationPointPayload,
  token?: string | null
): Promise<CalibrationPoint> {
  return apiRequest<CalibrationPoint>("/calibration/points/", {
    method: "POST",
    body: payload,
    token: token || undefined,
  });
}

export async function generateCalibrationModel(
  payload: GenerateModelPayload,
  token?: string | null
): Promise<CalibrationModel> {
  return apiRequest<CalibrationModel>("/calibration/generate/", {
    method: "POST",
    body: payload,
    token: token || undefined,
  });
}

export async function setActiveCalibrationModel(
  projectId: string,
  token?: string | null
): Promise<CalibrationModel> {
  return apiRequest<CalibrationModel>("/calibration/active/", {
    method: "POST",
    body: { project: projectId },
    token: token || undefined,
  });
}

export async function getActiveModel(
  projectId: string,
  token?: string | null
): Promise<CalibrationModel> {
  return apiRequest<CalibrationModel>(
    `/calibration/model/?project=${projectId}`,
    {
      method: "GET",
      token: token || undefined,
    }
  );
}

export async function deleteCalibrationPoint(
  pointId: string,
  token?: string | null
): Promise<void> {
  return apiRequest<void>(`/calibration/points/${pointId}/`, {
    method: "DELETE",
    token: token || undefined,
  });
}

export async function updateCalibrationPoint(
  pointId: string,
  payload: Partial<CreateCalibrationPointPayload>,
  token?: string | null
): Promise<CalibrationPoint> {
  return apiRequest<CalibrationPoint>(`/calibration/points/${pointId}/`, {
    method: "PATCH",
    body: payload,
    token: token || undefined,
  });
}

export type CalibrationDiagnosticPoint = {
  id: string;
  measured_fc: number;
  predicted_fc: number;
  upv: number;
  rh_index: number;
  carbonation_depth?: number | null;
  created_at: string;
};

export type CalibrationDiagnostics = {
  model: CalibrationModel;
  points: CalibrationDiagnosticPoint[];
};

export async function getCalibrationDiagnostics(
  projectId: string,
  token?: string | null
): Promise<CalibrationDiagnostics> {
  return apiRequest<CalibrationDiagnostics>(
    `/calibration/diagnostics/?project=${projectId}`,
    {
      method: "GET",
      token: token || undefined,
    }
  );
}
